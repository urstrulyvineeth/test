import subprocess
import json
import os

def lambda_handler(event, context):
    repo_url = event.get('repo_url')  # OR event['s3_path']
    project_path = "/tmp/project"

    # Clone the Git repo
    subprocess.run(["git", "clone", repo_url, project_path])

    # Run snyk test
    result = subprocess.run(["snyk", "test", "--json"], cwd=project_path, capture_output=True, text=True)

    output = json.loads(result.stdout)
    severities = {"critical": 0, "high": 0, "medium": 0, "low": 0}
    for vuln in output.get("vulnerabilities", []):
        level = vuln["severity"]
        severities[level] += 1

    return {
        "statusCode": 200,
        "body": json.dumps(severities)
    }
