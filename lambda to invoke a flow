const {
  BedrockAgentRuntimeClient,
  StartFlowExecutionCommand,
} = require("@aws-sdk/client-bedrock-agent-runtime");

exports.handler = async (event) => {
  try {
    const body = typeof event.body === "string" ? JSON.parse(event.body) : event.body;

    if (!body || !body.document) {
      return {
        statusCode: 400,
        body: JSON.stringify({
          error: "Missing 'document' in request body. Expected: { \"document\": \"<url or code>\" }"
        }),
      };
    }

    const client = new BedrockAgentRuntimeClient({ region: "eu-central-1" });

    const command = new StartFlowExecutionCommand({
      flowId: "6O7NUDSMF0",      // ✅ your Flow ID
      flowVersion: "1",          // ✅ published version
      inputParameters: {
        document: body.document, // ✅ must match the Flow InputNode ID
      },
    });

    const response = await client.send(command);

    return {
      statusCode: 200,
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        message: "Flow executed successfully",
        executionResult: response,
      }),
    };

  } catch (error) {
    console.error("Flow execution error:", error);
    return {
      statusCode: 500,
      body: JSON.stringify({
        error: "Flow execution failed",
        details: error.message || "Unknown error",
      }),
    };
  }
};
